---
title: 'Negativas de acesso a informação no governo Federal'
subtitle: 'Órgãos e entidades do poder Executivo - janeiro de 2015 até 2021'
output:
  html_document: 
    code_folding: hide
    toc: yes
    toc_depth: 4
    theme: paper
    df_print: default
    highlight: tango
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = T,
  comment = "#>",
  message = F,
  warning = F,
  echo = T,
  fig.width = 8,
  fig.height = 5
)
```

```{r libs}
library(tidyverse)
library(lubridate)
library(glue)
library(here)
library(ggtext)
library(patchwork)
library(kableExtra)
library(hrbrthemes)
library(tidytext)
```

```{r set-options}
set.seed(1014)

knitr::knit_hooks$set(inline = function(x) prettyNum(x, big.mark = ".", decimal.mark = ","))

options(
  digits = 1,
  scipen = 999,
  OutDec = ",",
  knitr.kable.NA = "",
  radian.auto_match = FALSE
)

Sys.setenv(LANGUAGE = "pt-br")
Sys.setlocale("LC_TIME", "pt_BR")

# helper
`%notin%` <- function(x, y) !(x %in% y)
```


```{r color-settings}
# aplica identidade visual da TB/AeP:
cores_aep <- c(
  laranja = "#F9A521",
  rosa = "#D81755",
  cinza = "#969696",
  marrom = "#B27D5C"
)

cores_tb <- c(
  laranja = "#F6A323",
  cinza_escuro = "#1d1d1b",
  cinza_claro = "#6f7171",
  cinza_quase_branco = "#ececec",
  azul = "#41ACBD"
)

cores_decisao <- c(
  "Acesso Concedido" = cores_tb[["azul"]],
  "Não se trata de solicitação de informação" = cores_aep[["marrom"]],
  "Acesso Negado" = cores_aep[["rosa"]],
  "Acesso Parcialmente Concedido" = cores_aep[["laranja"]],
  "Pergunta Duplicada/Repetida" = cores_aep[["cinza"]],
  "Órgão não tem competência para responder sobre o assunto" = cores_tb[["cinza_escuro"]],
  "Informação Inexistente" = cores_tb[["cinza_quase_branco"]]
  )

cores_decisao2 <- cores_decisao
cores_decisao2[["Informação Inexistente"]] <- "gray20"

cores_decisao3 <- c("black", "gray90", "gray20", "gray80", "gray20")
names(cores_decisao3) <- names(cores_decisao)[-c(5, 2)] 

cores_lai <- tibble(
  c1 = c("Não se trata de solicitação de informação",
         "Pergunta Duplicada/Repetida",
         "Pedidos de acesso a informação via LAI"
         ) %>% str_wrap(25),
  c2 = c("#F9A521", "#969696", "#D81755")
) %>% deframe()
```

```{r}
periodo_final <- "2021-08-01"
instancias_recursais <- c(
  "Primeira Instância",
  "Segunda Instância",
  "Terceira Instância",
  "CGU",
  "CMRI",
  "Pedido de Revisão",
  "Não houve recurso"
)

pedidos_cgu <- readRDS(here("dados/load/rds/pedidos-clean.rds")) %>%
  filter(data_resposta <= periodo_final, data_resposta <= periodo_final) %>% 
  rename(orgao = orgaodestinatario)

pedidos_cgu <- pedidos_cgu %>% 
  filter(decisao %notin% c(
    "Pergunta Duplicada/Repetida",
    "Não se trata de solicitação de informação"
  ))

controversos_lgpd <- "dados/load/rds/controversos_lgpd.rds" %>% 
  here() %>%
  readRDS() %>% 
  mutate(tipo = case_when(
    controversos_lgpd_pedido & controversos_lgpd_resposta ~ "Pedido e reposta mencionam LGPD",
    controversos_lgpd_pedido & !controversos_lgpd_resposta ~ "Pedido menciona LGPD, resposta não",
    !controversos_lgpd_pedido & controversos_lgpd_resposta ~ "Pedido não menciona LGPD, resposta menciona",
    TRUE ~ "Não menciona LGPD"
  ))
```

```{r}
result <- controversos_lgpd %>% count(controversos_lgpd_pedido, controversos_lgpd_resposta)
result

controversos_lgpd <- controversos_lgpd %>% filter(tipo != "Não menciona LGPD")
```

## Metodologia

* Foi feita uma busca por palavras-chave nos conteúdos do **pedido** e da **resposta**
* A busca foi feita com a seguinte regex:
  * `'lei geral de proteção de dados|lei de protecao de dados pessoais|13\\.?709|lgpd'`
* Descartamos os pedidos que não tiveram a regex detectada (consideramos que eles não abordam LGPD). 
  * Resultado:
    * Regex não detectada - não menciona LGPD: `r result[1,3, drop=T]`
    * Regex detectada - menciona LGPD: `r sum(result[2:4,3, drop=T])`
      * regex detectada somente no conteúdo da resposta: `r result[2,3, drop=T]`
      * regex detectada somente no conteúdo do pedido: `r result[3,3, drop=T]`
      * regex detectada nos conteúdos do pedido e da resposta: `r result[4,3, drop=T]`

## Presença do termo LGPD nas respostas e cumprimento da LAI


```{r}
controversos_lgpd  %>% 
  count(tipo, ano = year(data_resposta), sort = T) %>% 
  ggplot(aes(x = ano, y = n, color = tipo)) +
  geom_line(size = 2, alpha = .6)  +
  geom_point() +
  #geom_text(aes(label = n), vjust = -.3) +
  labs(
    title = "Pedidos com menções à LGPD na resposta",
    x = NULL,
    color = "Onde a LGPD foi mencionada:",
    y = "Quantidade de pedidos"
  ) +
  theme_minimal()
```

```{r fig.width=8}
controv <- pedidos_cgu %>% 
  filter(decisao %notin% c(
      "Pergunta Duplicada/Repetida",
      "Não se trata de solicitação de informação"
    )) %>%
  select(id_pedido, data_resposta, orgao, decisao) %>% 
  inner_join(controversos_lgpd) 

aux <- cores_decisao %>% 
  enframe() %>% 
  mutate(name = str_wrap(name, 25)) %>% 
  deframe()

aux2 <- cores_decisao3 %>% 
  enframe() %>% 
  mutate(name = str_wrap(name, 25)) %>%
  deframe()

controv %>%  
  count(ano = year(data_resposta), tipo, decisao, name = "n_ano") %>% 
  mutate(decisao = str_wrap(decisao, 25)) %>% 
  complete(ano, decisao, fill = list(n_ano = 0)) %>% 
  filter(!is.na(tipo)) %>%
  filter(tipo == "Pedido não menciona LGPD, resposta menciona") %>% 
  
  ggplot(aes(x = ano, y = n_ano, fill = reorder(decisao, n_ano),
             color = reorder(decisao, n_ano))) +
  geom_line(size = 1, alpha = .8)  +
  geom_point() +
  labs(
    x = "Pedidos com"
  )
  facet_wrap(~reorder(tipo, -n_ano))
```

## Uso da LGPD por órgão e decisão

```{r}
controv %>% 
  count(orgao, decisao, sort = T) %>%
  mutate(ord = 1:n(),
         decisao = str_wrap(decisao, 25),
         orgao = str_wrap(orgao, 30)) %>%
  add_count(orgao, wt = n, name = "n_total_orgao") %>%
  filter(ord < 21) %>% 
  ggplot(aes(x = reorder(orgao, n, sum), y = n, fill = reorder(decisao, -n))) +
  geom_col(color = "gray20") +
  geom_text(aes(label = n_total_orgao, y = n_total_orgao), check_overlap = T,
            hjust = -.5) +
  coord_flip() +
  scale_fill_manual(values = aux) +
  labs(
    title = "Órgãos que mencionaram LGPD em suas respostas",
    fill = "Decisão",
    x = NULL, y = "Quantidade"
  ) +
  ylim(c(0, 1000)) +
  theme_minimal() +
  theme(
    legend.text = element_text(size = 8, margin = margin(5, 0, 5, 0, "pt"))
  )
```

## Assunto dos pedidos que mencionam LGPD:

```{r}
controv %>% 
  left_join(select(pedidos_cgu, id_pedido, sub_assunto_pedido, assunto_pedido)) %>% 
  count(assunto_pedido, sort = TRUE, name = "Quantidade de pedidos") %>% 
  mutate(assunto_pedido_desc = "Assunto do pedido (informado pelo órgão)") %>% 
  pivot_wider(values_from = assunto_pedido, names_from = assunto_pedido_desc, values_fn = list) %>%
  select(`Assunto do pedido (informado pelo órgão)`, `Quantidade de pedidos`) %>% 
  # mutate(termo_concat = map_chr(termo, paste0, collapse = ", "),
  #        termo_concat = str_wrap(termo_concat, 100)) %>% 
  kbl() %>% 
  kable_paper()
```


## Uso dos termos relacionados à LGPD

```{r eval = FALSE}
controv2 <- pedidos_cgu %>% 
  select(id_pedido, orgao, decisao, data_resposta, resposta) %>% 
  filter(orgao %in% unique(controv$orgao), year(data_resposta) > 2017) %>% 
  left_join(controv) %>% 
  mutate(controversos_lgpd = replace_na(controversos_lgpd, F),
         controverso_id = replace_na(controverso_id, "Outro"),
         decisao = str_wrap(decisao, 25),
         orgao = str_extract(orgao, "^[:upper:]*-?\\/?[:upper:]+([:lower:]{2})?(?= )|^CEITEC\\/S\\.A|UFCAT$")
         ) %>% 
  #add_count(ano = year(data_resposta), orgao, decisao, name = "n_ano_orgao_decisao") %>% 
  count(ano = year(data_resposta), orgao, decisao, controverso_id,
        name = "n_ano_orgao_decisao_lgpd") %>%
  add_count(ano, orgao, decisao, wt = n_ano_orgao_decisao_lgpd, name = "n_ano_orgao_decisao") %>% 
  add_count(ano, orgao, wt = n_ano_orgao_decisao_lgpd, name = "n_ano_orgao") %>% 
  add_count(orgao, wt = n_ano_orgao, name = "n_orgao_total") %>% 
  arrange(orgao, ano, decisao, controverso_id) 

my_lbl <- function(x) scales::percent(x, .1, decimal.mark = ",")

controv2 %>%
  filter(str_detect(orgao, "^MCIDADANIA|^INCRA|^CNPQ|^ME|^IMBEL")) %>% 
  mutate(decisao = str_replace_all(decisao, "\n", " ")) %>% 
  filter(controverso_id == "LGPD") %>% 
  mutate(tx = n_ano_orgao_decisao_lgpd / n_ano_orgao_decisao) %>% 
  group_by(orgao, decisao) %>%
  summarise(tx = sum(tx), .groups = "drop") %>%
  complete(orgao, decisao, fill = list(tx = 0)) %>% 
  arrange(-tx) %>%
  ggplot(aes(y = tx, x = reorder(orgao, -tx), fill = reorder(decisao, tx, sum))) +
  geom_col(color = "gray20", show.legend = F) +
  #coord_flip() +
  facet_wrap(reorder(decisao, -tx, sum) ~ ., ncol = 1, scales = "free_x") +
  geom_text(aes(label = if_else(tx == 0, NA_character_, my_lbl(tx))), vjust = -.5, size = 3.5) +
  scale_fill_manual(values = cores_decisao) +
  scale_y_percent(limits = c(0, 1.3), breaks = seq(0, 1, .25)) +
  theme_minimal() +
  theme(strip.text = element_text(hjust = 0)) +
  labs(
    title = "",
    fill = "Decisão",
    x = NULL,
    y = "% em relação ao total de decisões"
  )
```

## Word count para órgãos que mais utilizaram a LGPD nas respostas

```{r fig.height=50, fig.width=8}

t <- pedidos_cgu %>%
  select(id_pedido, data_registro, detalhamento_solicitacao, resposta, orgao, decisao) %>% 
  inner_join(controversos_lgpd) %>%
  mutate(sigla = str_extract(orgao, "^[:upper:]*-?\\/?[:upper:]+([:lower:]{2})?(?= )|^CEITEC\\/S\\.A|UFCAT$"))

o <- t %>%
  count(orgao, sigla, name = "n_manifestacao", sort = T) %>% 
  slice_max(n = 10, order_by = n_manifestacao)

clean_strings <- function(x) {
  x %>% 
    str_replace_all(" \\w ", " ") %>% 
    str_replace_all("gostaria", " ") %>% 
    str_replace_all("n°|nº", " ") %>% 
    str_replace_all("\\d", " ") %>%
    str_replace_all(" art ", " ") %>% 
    str_replace_all(" ser ", " ") %>%
    str_replace_all("º|°|ª", " ") %>% 
    str_replace_all(" ter ", " ") %>%
    str_replace_all(" sei ", " ") %>%
    str_replace_all("bom dia ", " ") %>%
    str_replace_all(" quais ", " ") %>%
    str_replace_all("saber|sobre", " ") %>% 
    str_squish()
}

p1 <- t %>% 
  #filter(str_detect(orgaodestinatario, "^CGU")) %>% 
  filter(orgao %in% o$orgao) %>%
  add_count(orgao, name = "total_orgao") %>% 
  mutate(detalhamento_solicitacao = clean_strings(detalhamento_solicitacao),
         orgao = glue("{sigla}\n{total_orgao} de manifestações")) %>% 
  unnest_tokens(word, detalhamento_solicitacao) %>%
  count(orgao, word, sort = TRUE) %>% 
  mutate(word = fct_reorder(word, word)) %>%
  group_by(orgao) %>% 
  slice_max(n = 15, order_by = n) %>%
  ungroup() %>% 
  ggplot(aes(n, word)) +
  geom_col() +
  labs(y = NULL,
       title = 'Pedidos') +
  facet_wrap(~reorder(orgao, orgao), scales = "free", ncol = 1) +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    axis.text.x = element_text(size = 9)
  )

p2 <- t %>% 
  #filter(str_detect(orgaodestinatario, "^CGU")) %>% 
  filter(orgao %in% o$orgao) %>%
  add_count(orgao, name = "total_orgao") %>% 
  mutate(resposta = clean_strings(resposta),
         orgao = glue("{sigla}\n de respostas")) %>% 
  unnest_tokens(word, resposta) %>%
  count(orgao, word, sort = TRUE) %>% 
  mutate(word = fct_reorder(word, word)) %>%
  group_by(orgao) %>% 
  slice_max(n = 15, order_by = n) %>%
  ungroup() %>% 
  ggplot(aes(n, word)) +
  geom_col() +
  labs(y = NULL,
       title = 'Respostas') +
  facet_wrap(~reorder(orgao, orgao), scales = "free", ncol = 1) +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    axis.text.x = element_text(size = 9)
  )

p1 + p2 + plot_annotation(
  title = "Termos frequêntes nas solicitações ocasionaram em menções\na LGPD na resposta"
)
```

