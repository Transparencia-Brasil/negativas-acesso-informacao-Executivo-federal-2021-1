---
title: 'Negativas de acesso a informação no governo Federal'
subtitle: 'Órgãos e entidades do poder Executivo - janeiro de 2015 até 2021'
output:
  html_document: 
    code_folding: hide
    toc: yes
    toc_depth: 4
    theme: paper
    df_print: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = T,
  comment = "#>",
  message = F,
  warning = F,
  echo = T,
  fig.width = 8,
  fig.height = 5
)
```

```{r}
library(tidyverse)
library(lubridate)
library(glue)
library(here)
library(ggtext)
library(patchwork)
library(kableExtra)
library(hrbrthemes)
library(tidytext)
```

```{r set-options}
set.seed(1014)

knitr::knit_hooks$set(inline = function(x) prettyNum(x, big.mark = ".", decimal.mark = ","))

options(
  digits = 1,
  scipen = 999,
  OutDec = ",",
  knitr.kable.NA = "",
  radian.auto_match = FALSE
)

Sys.setenv(LANGUAGE = "pt-br")
Sys.setlocale("LC_TIME", "pt_BR")

# helper
`%notin%` <- function(x, y) !(x %in% y)
```


```{r color-settings}
# aplica identidade visual da TB/AeP:
cores_aep <- c(
  laranja = "#F9A521",
  rosa = "#D81755",
  cinza = "#969696",
  marrom = "#B27D5C"
)

cores_tb <- c(
  laranja = "#F6A323",
  cinza_escuro = "#1d1d1b",
  cinza_claro = "#6f7171",
  cinza_quase_branco = "#ececec",
  azul = "#41ACBD"
)

cores_decisao <- c(
  "Acesso Concedido" = cores_tb[["azul"]],
  "Não se trata de solicitação de informação" = cores_aep[["marrom"]],
  "Acesso Negado" = cores_aep[["rosa"]],
  "Acesso Parcialmente Concedido" = cores_aep[["laranja"]],
  "Pergunta Duplicada/Repetida" = cores_aep[["cinza"]],
  "Órgão não tem competência para responder sobre o assunto" = cores_tb[["cinza_escuro"]],
  "Informação Inexistente" = cores_tb[["cinza_quase_branco"]]
  )

cores_decisao2 <- cores_decisao
cores_decisao2[["Informação Inexistente"]] <- "gray20"

cores_decisao3 <- c("black", "gray90", "gray20", "gray80", "gray20")
names(cores_decisao3) <- names(cores_decisao)[-c(5, 2)] 

cores_lai <- tibble(
  c1 = c("Não se trata de solicitação de informação",
         "Pergunta Duplicada/Repetida",
         "Pedidos de acesso a informação via LAI"
         ) %>% str_wrap(25),
  c2 = c("#F9A521", "#969696", "#D81755")
) %>% deframe()
```

Análises de pedidos de acesso a informação via LAI considerando a decisão de acesso.

> **Atenção**: Eu fiz os agrupamentos para visualizar os órgãos de maneira mais focada, mas os critérios apenas intuitivos e baseados nos próprios nomes dos órgãos.

```{r}
pedidos_painel <- "dados/load/rds/base_cgu.rds" %>%
  here() %>%
  readRDS() %>%
  pluck("pedidos") %>%
  janitor::clean_names() %>% 
  mutate(
    ts_registro = data_registro,
    ts_resposta = data_resposta,
    data_registro = dmy(data_registro) %>% floor_date(unit = "month"),
    data_resposta = dmy(data_resposta) %>% floor_date(unit = "month")) %>% 
  rename(orgao = orgao_destinatario) %>%
  filter(!is.na(decisao),
         !is.na(data_resposta),
         data_registro < ymd("2021-10-01"), 
         esfera == "Federal")

pedidos_cgu <- readRDS(here("dados/load/rds/pedidos-clean.rds")) %>%
  #filter(data_resposta <= periodo_final, data_resposta <= periodo_final) %>% 
  rename(orgao = orgaodestinatario)
```

```{r}
orgaos_count_decisao <- pedidos_painel %>%
  select(id_pedido, data_registro, decisao, orgao) %>%
  add_count(data_registro, name = "n_mes") %>%
  add_count(data_registro, orgao, name = "n_mes_orgao") %>%
  add_count(data_registro, decisao, name = "n_mes_decisao") %>%
  add_count(data_registro, decisao, orgao, name = "n_mes_decisao_orgao") %>% 
  select(id_pedido:n_mes, n_mes_decisao, n_mes_orgao, n_mes_decisao_orgao)

wafflechart_acesso_negado <- function(x) {
  
  orgaos_count_decisao %>%
    filter(str_detect(orgao, x),
           decisao == "Acesso Negado") %>% #distinct(orgao) %>% arrange(orgao) %>%
    mutate(
      taxa_interna = n_mes_decisao_orgao / n_mes_orgao,
      taxa_global = n_mes_decisao_orgao / n_mes_decisao,
      #orgao = str_wrap(orgao, 25)
    ) %>% 
    group_by(orgao) %>% 
    filter(mean(n_mes_orgao) >= 10) %>% 
    ungroup() %>% 
    group_by(ano = year(data_registro),
             orgao) %>% 
    summarise(
      `Taxa interna máxima registrada em um ano` = max(taxa_interna, na.rm = T),
      `Taxa global máxima registrada em um ano` = max(taxa_global, na.rm = T),
      .groups = "drop"
    ) %>% 
    pivot_longer(
      -c(ano, orgao),
      names_to = "categoria",
      values_to = "valor",
    ) %>%
    complete(ano, orgao, categoria) %>% 
    filter(categoria == "Taxa interna máxima registrada em um ano") %>% 
    ggplot(aes(x = factor(ano),
               y = reorder(orgao, valor, na.rm = T),
               fill = valor)) +
    geom_tile(color = "gray80") +
    geom_text(
      data = . %>% 
        filter(valor >= .15 | (valor >= .1 & str_detect(orgao, "^MEC "))),
      aes(label = scales::percent(valor, accuracy = 0.1, decimal.mark = ",")),
      size = 2.5) +
    scale_x_discrete(position = "top") +
    scale_fill_gradientn(
      colors = c("white", cores_aep[["laranja"]], cores_aep[["rosa"]]),
      na.value = "gray90",
      labels = scales::percent_format()
    ) +
    theme_minimal() +
    theme(
      panel.grid = element_blank(),
      legend.position = "top",
      legend.direction = "horizontal",
      legend.justification = "left"
    ) +
    labs(
      title = "Maiores % de negativas de acess por ano",
      subtitle = "Proporção de pedidos negados em relação ao\ntotal de pedidos recebidos pe  las pastas ministeriais",
      x = NULL,
      y = NULL,
      fill = "%"
    )

}

```

### Órgãos militares

```{r}

militares <- "^(CEX|CMAR|COMAER|DPF|IMBEL|DPRF|^AMAZUL)"
ministerio <- "Ministério|^CGU|^CC-PR|^SEGOV|^SGPR|^AGU|^GSI|^VPR|^PR"
empresa_publica <- "Ltda$|S\\.A\\.?$|Empresa|Companhia"
educacao <- "Universidade|Escola|Colégio|Instituto Federal de Educação|^CEFET"
saude <- "EBSERH|Hospital|Maternidade"
bancos <- "^(BB|CEF|CMB)\\s|Banco"
cultura <- c(
  "ANCINE",
  "FBN",
  "FCP",
  "FUNARTE",
  "FCRB",
  "IPHAN",
  "FUNDAJ"
) %>% paste(collapse = "|")
cultura <- glue("^({cultura})\\s|Museu")

meio_ambiente <- c(
  "ANA",
  "FUNAI",
  "ICMBio",
  "IBAMA",
  "INCRA",
  "INPA"
) %>% paste(collapse = "|")
meio_ambiente <- glue("^({meio_ambiente})\\s")

ciencia <- c(
  "AEB",
  "CAPES",
  "CNPQ",
  "FINEP",
  "FNDE",
  "CBPF",
  "JBRJ",
  "CETEM",
  "CETENE",
  "CNEN",
  "INT",
  "LNCC-MCT",
  "ON-MCT",
  "LNA",
  "INPI",
  "ITI",
  "INPE-MCT",
  "IBICT",
  "CTI",
  "IPEA",
  "FIOCRUZ",
  "IBC",
  "IBGE",
  "INEP",
  "INES",
  "INSA",
  "FUNDACENTRO",
  "FUNASA"
) %>% paste(collapse = "|")
ciencia <- glue("^({ciencia})\\s")

agencias_reguladoras <- c(
  "INMETRO",
  "ANA(C|TEL)?",
  "ANEEL",
  "ANTAQ",
  "ANTT",
  "ANP",
  "ANM",
  "ANPD",
  "ANS",
  "ANVISA",
  "CADE",
  "COAF",
  "CVM",
  "SERPRO"
) %>% paste(collapse = "|")
agencias_reguladoras <- glue("^({agencias_reguladoras})\\s")


pedidos_painel %>% distinct(orgao) %>% 
  arrange(orgao) %>% 
  filter(
    !str_detect(orgao, educacao),
    !str_detect(orgao, saude),
    !str_detect(orgao, militares),
    !str_detect(orgao, ministerio),
    !str_detect(orgao, empresa_publica),
    !str_detect(orgao, bancos),
    !str_detect(orgao, cultura),
    !str_detect(orgao, meio_ambiente),
    !str_detect(orgao, ciencia),
    !str_detect(orgao, agencias_reguladoras)
  ) %>% print(n = Inf)
```

### Pastas ministeriais

```{r fig.width=11, fig.height=7}
wafflechart_acesso_negado(ministerio)
```

### Órgãos militares

```{r}
wafflechart_acesso_negado(militares)
```

### Órgãos sócioambientais

```{r}
wafflechart_acesso_negado(meio_ambiente)
```

### Bancos públicos

```{r}
wafflechart_acesso_negado(bancos)
```

### Ciência, pesquisa e educação

```{r fig.width=11, fig.height=7}
wafflechart_acesso_negado(ciencia)
```

```{r fig.width=11, fig.height=10}
wafflechart_acesso_negado(educacao)
```

```{r fig.width=11, fig.height=10}
#wafflechart_acesso_negado(saude)
```

### empresas públicas

```{r fig.width=11, fig.height=10}
wafflechart_acesso_negado(empresa_publica)
```

### Cultura

```{r}
wafflechart_acesso_negado(cultura)
```

### Agencias reguladoras

```{r}
wafflechart_acesso_negado(agencias_reguladoras)
```

### INSS

```{r}
wafflechart_acesso_negado("INSS")
```

