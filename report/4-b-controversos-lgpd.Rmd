---
title: 'Negativas de acesso a informação no governo Federal'
subtitle: 'Órgãos e entidades do poder Executivo - janeiro de 2015 até 2021'
output:
  html_document: 
    code_folding: hide
    toc: yes
    toc_depth: 4
    theme: paper
    df_print: default
    highlight: tango
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = T,
  comment = "#>",
  message = F,
  warning = F,
  echo = T,
  fig.width = 8,
  fig.height = 5
)
```

```{r libs}
library(tidyverse)
library(lubridate)
library(glue)
library(here)
library(ggtext)
library(patchwork)
library(kableExtra)
library(hrbrthemes)
library(tidytext)
```

```{r set-options}
set.seed(1014)

knitr::knit_hooks$set(inline = function(x) prettyNum(x, big.mark = ".", decimal.mark = ","))

options(
  digits = 1,
  scipen = 999,
  OutDec = ",",
  knitr.kable.NA = "",
  radian.auto_match = FALSE
)

Sys.setenv(LANGUAGE = "pt-br")
Sys.setlocale("LC_TIME", "pt_BR")

# helper
`%notin%` <- function(x, y) !(x %in% y)
```

```{r color-settings}
source(here("src/0-paleta-de-cores.R"), encoding = "UTF-8")

theme_set(theme_minimal())

theme_update(
  panel.grid.minor = element_blank(),
  panel.background = element_rect(fill = "gray97", color = "transparent")
)
```

```{r}
pedidos_cgu <- "dados/load/rds/pedidos-cgu.rds" %>% 
  here() %>% 
  readRDS() %>%
  rename(orgao = orgaodestinatario)

pedidos_clean <- "dados/load/rds/pedidos-clean.rds" %>% 
  here() %>% 
  readRDS() 

recursos_clean <- "dados/load/rds/recursos-clean.rds" %>% 
  here() %>% 
  readRDS() 
```

```{r}
pedidos_clean <- pedidos_clean %>% 
  mutate(
    usa_lgpd_pedido_resumido = str_detect(resumo_solicitacao_clean, "LGPD"),
    usa_lgpd_pedido = str_detect(detalhamento_solicitacao_clean, "LGPD"),
    usa_lgpd_resposta = str_detect(resposta_clean, "LGPD")
  )

lgpd <- pedidos_cgu %>% 
  select(
    id_pedido, orgao, data_registro,
    resumo_solicitacao, detalhamento_solicitacao, 
    resposta, decisao, assunto_pedido
  ) %>% 
  left_join(pedidos_clean) %>%
  mutate(
    usa_lgpd_assunto = assunto_pedido == "Dados Pessoais - LGPD",
    usa_lgpd_pedido_resumido = replace_na(usa_lgpd_pedido_resumido, FALSE),
    usa_lgpd = !(!usa_lgpd_pedido_resumido & 
                  !usa_lgpd_pedido &
                  !usa_lgpd_resposta & 
                  !usa_lgpd_assunto)
    )
```

### Evolução de uso da LGPD em pedidos LAI

```{r}
lgpd %>% 
  filter(year(data_registro) >= 2018) %>% 
  count(data_registro, usa_lgpd) %>% 
  mutate(usa_lgpd = if_else(usa_lgpd, "Sim (quantidade)", "Não")) %>% 
  ggplot(aes(x = data_registro, y = n, fill = reorder(usa_lgpd, n))) +
  geom_col() +
  geom_text(
    data = . %>%
      add_count(data_registro, wt = n) %>% 
      filter(usa_lgpd == "Não") %>%
      mutate(nn - n) %>% 
      filter(`nn - n` > 0),
    aes(
      y = nn,
      label = `nn - n`,
    ),
    color = cores_aep[["rosa"]],
    vjust = -.5,
    hjust = 0,
    size = 2.5,
    fontface = "bold",
    angle = 45
  ) +
  labs(
    title = "Detecção dos termos relacionados a LGPD",
    subtitle = "Considerando resumo do pedido, pedido (completo), resposta",
    x = NULL,
    y = "Quantidade de pedidos",
    fill = "Pedido\nmenciona LGPD"
  ) +
  scale_fill_manual(values = c(cores_aep[["rosa"]], alpha(cores_aep[["laranja"]], .5))) +
  scale_x_date(date_breaks = "6 months", date_labels = "%b-%Y") +
  theme(axis.ticks.x = element_line())
```

### Onde a LGPD foi mencionada

```{r}
lgpd %>% 
  select(data_registro, where(is.logical)) %>% 
  filter(usa_lgpd) %>% 
  mutate(
    ano = year(data_registro),
    mencao_lgpd = case_when(
      !usa_lgpd_assunto &
        !usa_lgpd_pedido &
        !usa_lgpd_pedido_resumido ~ str_glue("Solicitante não menciona LGPD em pedido,",
                                             "\nórgão menciona na resposta"),
      TRUE ~ "Solicitante menciona LGPD no pedido ou assunto do pedido"
    )
  ) %>% 
  count(ano, mencao_lgpd) %>% 
  ggplot(aes(x = ano, y = n, color = reorder(mencao_lgpd, -n))) +
  geom_line(
    data = . %>%
      filter(mencao_lgpd != str_glue("Solicitante não menciona LGPD em pedido,",
                                     "\nórgão menciona na resposta")),
    size = 1.3) +
  geom_point(
    data = . %>%
      filter(mencao_lgpd == str_glue("Solicitante não menciona LGPD em pedido,",
                                     "\nórgão menciona na resposta")),
    size = 1.3) +
  geom_line(
    data = . %>%
      filter(mencao_lgpd == str_glue("Solicitante não menciona LGPD em pedido,",
                                     "\nórgão menciona na resposta")),
    size = 1.5) +
  geom_point(
    data = . %>%
      filter(mencao_lgpd == str_glue("Solicitante não menciona LGPD em pedido,",
                                     "\nórgão menciona na resposta")),
    size = 1.5) +
  scale_color_manual(values = c(cores_aep[["rosa"]], cores_aep[["laranja"]])) +
  labs(title = "Onde a LGPD foi mencionada",
       color = NULL,
       x = "Quantidade",
       y = "Ano"
       ) +
  theme(legend.position = "top",
        legend.direction = "vertical")
```

### Uso da LGPD pelos órgãos para responder uma demanda qualquer via LAI

Quantidade de vezes que órgãos citaram LGPD para responder algum pedido: 

O termo LGPD foi detectado na resposta do pedido, mas o solicitante não menciona o assunto no pedido (o termo não é detectado no pedido).

```{r fig.height=4}
qt_lgpd <- lgpd %>% 
  filter(
    usa_lgpd_resposta &
     !usa_lgpd_pedido & 
     !usa_lgpd_pedido_resumido & 
     assunto_pedido != "Dados Pessoais - LGPD" 
  ) %>% 
  count(ano = year(data_registro), usa_lgpd_resposta, usa_lgpd_pedido) 

qt_lgpd %>% 
  ggplot(aes(x = ano, y = cumsum(n))) +
  geom_col(fill = cores_aep[["laranja"]]) +
  geom_text(aes(label = cumsum(n)), vjust = 0) +
  labs(
    title = "Quantidade acumulada de respostas dadas citando LGPD",
       subtitle = str_glue("Até o período atual foram {sum(qt_lgpd$n)} ",
                           "usos da LGPD em respostas aos solicitantes pelos órgãos,\n",
                           "sem que os solicitantes façam menções à LGPD no pedido"),
       x = "Ano", y = "Quantidade (acumulada)"
  )
```

### Assuntos onde o órgão mencionou a LGPD

```{r}
lgpd %>% 
  filter(
    usa_lgpd_resposta &
     !usa_lgpd_pedido & 
     !usa_lgpd_pedido_resumido & 
     assunto_pedido != "Dados Pessoais - LGPD" 
  ) %>% 
  count(assunto_pedido, sort = T) %>%
  slice_max(n = 10, order_by = n) %>% 
  ggplot(aes(x = reorder(assunto_pedido, n), y = n)) +
  geom_col(fill = cores_tb[["azul"]]) +
  geom_text(aes(label = n), hjust = 0) +
  labs(
    title = "10 principais assuntos em que em que o órgão mencionou LGPD\nna resposta",
    y = "Quntidade de pedidos",
    x = NULL
  ) +
  coord_flip()
```

### Decisões quando órgão menciona LGPD

```{r}
lgpd %>% 
  filter(
    usa_lgpd_resposta &
     !usa_lgpd_pedido & 
     !usa_lgpd_pedido_resumido & 
     assunto_pedido != "Dados Pessoais - LGPD" 
  ) %>% 
  count(decisao, sort = T) %>%
  slice_max(n = 10, order_by = n) %>% 
  ggplot(aes(x = reorder(decisao, n), y = n)) +
  geom_col(aes(fill = decisao), show.legend = F) +
  geom_text(aes(label = n), hjust = 0) +
  labs(
    title = "Decisão mais frequente quando órgão menciona LGPD na resposta",
    y = "Quntidade de pedidos",
    x = NULL
  ) +
  scale_fill_manual(values = cores_decisao2) +
  coord_flip()
```

### Wordcloud no pedido quando órgão usa LGPD

Wordcloud extraída do texto do pedido (campo `detalhamento_solicitacao`)

```{r fig.height=7, fig.width=7}
library(tidytext)
library(wordcloud)
source(here("src/5-funcao-limpando-texto.R"))

lgpd %>% 
  filter(
    usa_lgpd_resposta &
     !usa_lgpd_pedido & 
     !usa_lgpd_pedido_resumido & 
     assunto_pedido != "Dados Pessoais - LGPD" 
  ) %>% 
  select(id_pedido, detalhamento_solicitacao_clean) %>% 
  unnest_tokens(word, detalhamento_solicitacao_clean) %>% 
  anti_join(stopwords) %>% 
  mutate(word = str_extract(word, "[a-z']+")) %>% 
  filter(word != "ddmmyyyy") %>% 
  count(word, sort = T) %>% 
  with(wordcloud(word, n, max.words = 200, scale = c(7, 1), 
          random.order = F,
          random.color = F,
          colors = c(cores_aep[2], cores_tb[5])))
```

Wordcloud extraída do texto do resumo do pedido (campo `resumo_solicitacao`)

```{r fig.height=7, fig.width=7}
lgpd %>% 
  filter(
    usa_lgpd_resposta &
     !usa_lgpd_pedido & 
     !usa_lgpd_pedido_resumido & 
     assunto_pedido != "Dados Pessoais - LGPD" 
  ) %>% 
  select(id_pedido, resumo_solicitacao_clean) %>% 
  unnest_tokens(word, resumo_solicitacao_clean) %>% 
  anti_join(stopwords) %>% 
  mutate(word = str_extract(word, "[a-z']+")) %>% 
  filter(word != "ddmmyyyy") %>% 
  count(word, sort = T) %>% 
  with(wordcloud(word, n, max.words = 200, scale = c(7, 1), 
          random.order = F,
          random.color = F,
          colors = c(cores_aep[2], cores_tb[5])))
```

Wordcloud extraída da resposta do pedido, onde foi detectada a menção à LGPD

```{r fig.height=7, fig.width=7}
lgpd %>% 
  filter(
    usa_lgpd_resposta &
     !usa_lgpd_pedido & 
     !usa_lgpd_pedido_resumido & 
     assunto_pedido != "Dados Pessoais - LGPD" 
  ) %>% 
  select(id_pedido, resposta_clean) %>% 
  unnest_tokens(word, resposta_clean) %>% 
  anti_join(stopwords) %>% 
  mutate(word = str_extract(word, "[a-z']+"),
         word = if_else(word == "urltag", "URL-link", word)) %>% 
  filter(word != "ddmmyyyy") %>% 
  count(word, sort = T) %>% 
  with(wordcloud(word, n, max.words = 200, scale = c(7, 1), 
          random.order = F,
          random.color = F,
          colors = c(cores_aep[2], cores_tb[5])))
```

### Órgãos que mais usaram LGPD em respostas

```{r}

```

