---
title: 'Recursos'
subtitle: 'Órgãos e entidades do poder Executivo'
output:
  html_document: 
    code_folding: hide
    toc: yes
    toc_depth: 4
    theme: paper
    df_print: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = T,
  comment = "#>",
  message = F,
  warning = F,
  echo = T,
  fig.width = 8,
  fig.height = 5
)
```

```{r libs}
library(tidyverse)
library(lubridate)
library(glue)
library(here)
library(ggtext)
library(patchwork)
library(kableExtra)
library(hrbrthemes)
library(tidytext)
```

```{r set-options}
set.seed(1014)

knitr::knit_hooks$set(
  inline = function(x) prettyNum(x, big.mark = ".", decimal.mark = ",")
  )

options(
  digits = 1,
  scipen = 999,
  OutDec = ",",
  knitr.kable.NA = "",
  radian.auto_match = FALSE
)

Sys.setenv(LANGUAGE = "pt-br")

# helper
`%notin%` <- function(x, y) !(x %in% y)
```

```{r color-settings}
source(here("src/0-paleta-de-cores.R"))
```

```{r}
#' base de dados de pedidos - completa
pedidos_painel <- "dados/load/rds/base-cgu.rds" %>%
  here() %>%
  readRDS() %>%
  pluck("pedidos") %>%
  janitor::clean_names() %>% 
  mutate(
    ts_registro = data_registro,
    ts_resposta = data_resposta,
    data_registro = dmy(data_registro) %>% floor_date(unit = "month"),
    data_resposta = dmy(data_resposta) %>% floor_date(unit = "month")) %>% 
  rename(orgao = orgao_destinatario) %>%
  filter(!is.na(decisao),
         !is.na(data_resposta),
         data_registro < ymd("2021-10-01"), 
         esfera == "Federal")

#' base de dados de recursos - completa
recursos_painel <- "dados/load/rds/base-cgu.rds" %>%
  here() %>%
  readRDS() %>%
  pluck("recursos_reclamacoes") %>%
  janitor::clean_names() %>% 
  mutate(
    ts_registro = data_registro,
    ts_resposta = data_resposta,
    data_registro = dmy(data_registro) %>% floor_date(unit = "month"),
    data_resposta = dmy(data_resposta) %>% floor_date(unit = "month")) %>% 
  rename(orgao = orgao_destinatario) %>%
  filter(!is.na(instancia),
         !is.na(data_resposta),
         data_registro < ymd("2021-10-01"), 
         esfera == "Federal")
```

```{r}
depara_orgao <- pedidos_painel %>%
  select(id_pedido, orgao, decisao)

inst <- c(
  "Primeira Instância",
  "Segunda Instância",
  "CGU",
  "CMRI",
  "Pedido de Revisão"
)
```

```{r}
#' 1015 recursos com tipo_recurso="Não concorda com a transformação do pedido em manifestação" e resposta indeferida.
#' Não é possível saber a origem desses pedidos nem o órgão.
recursos_painel %>% 
  filter(!id_pedido %in% depara_orgao$id_pedido) %>% count(tipo_recurso, orgao,tipo_resposta )
```

```{r}
count_recursos <- recursos_painel %>% 
  transmute(
    id_pedido,
    id_recurso,
    instancia = factor(instancia, levels = inst),
    orgao
  ) %>% 
  arrange(id_pedido, instancia) %>%
  group_by(id_pedido) %>% 
  mutate(
    ord = row_number(),
    orgao_old = orgao,
  ) %>%
  ungroup() %>%  
  select(-orgao) %>% 
  group_by(id_pedido) %>% 
  filter(ord == max(ord)) %>% 
  ungroup() %>%
  filter(id_pedido %in% depara_orgao$id_pedido) %>% 
  left_join(depara_orgao, .) %>% 
  select(id_pedido:decisao, instancia) %>% 
  count(orgao, decisao, instancia,
        name = "qt_orgao_decisao_instancia") %>% 
  add_count(orgao, instancia, wt = qt_orgao_decisao_instancia,
            name = "qt_orgao_instancia") %>% 
  add_count(orgao, wt = qt_orgao_decisao_instancia,
            name = "qt_pedidos") 
```

```{r}
plot_correlacao_negativas_e_recursos <- function(df, decisao_pedido) {
  
  df <- df %>%
    group_by(orgao) %>% 
    mutate(
      qt_decisao = sum(if_else(
          decisao == decisao_pedido,
          qt_orgao_decisao_instancia,
          NA_integer_), 
        na.rm = T),
      qt_recurso = sum(if_else(
          !is.na(instancia),
          qt_orgao_decisao_instancia,
          NA_integer_),
        na.rm = T)
    ) %>% 
    ungroup() %>%
    filter(!is.na(instancia), decisao == decisao_pedido,
           instancia != "Pedido de Revisão") %>% 
    mutate(
      perc_decisao = qt_decisao / qt_pedidos,
      perc_recursos_quando_decisao = qt_orgao_decisao_instancia / qt_recurso
    ) %>% 
    group_by(instancia) %>% 
    mutate(correl = cor(perc_decisao, 
                        perc_recursos_quando_decisao)) %>% 
    ungroup()

  df %>% 
    ggplot(aes(x = perc_decisao,
               y = perc_recursos_quando_decisao,
               color = instancia,
               fill = instancia, size = qt_decisao)) +
    geom_point(shape = 21, alpha = .7, color = "gray50") +
    geom_smooth(method = "lm", se = F) +
    hrbrthemes::scale_y_percent() +
    hrbrthemes::scale_x_percent() +
    labs(
      title = str_glue("Correlação entre decisões de {tolower(decisao_pedido)}",
                       " e recursos"),
      subtitle = str_glue("O tamanho do ponto é proporcional à quantidade",
                          " de pedidos com decisao de {tolower(decisao_pedido)}"),
      x = str_glue("{decisao_pedido}\n(% do total de pedidos recebidos)"),
      y = str_glue("Recursos quando a decisão é {tolower(decisao_pedido)}\n",
                   "(% do total de recursos impetrados ao órgão)")
    ) +
    theme_minimal() +
    theme(legend.position = "none") +
    facet_grid(~ instancia)
  
}
```

```{r fig.width=10}
plot_correlacao_negativas_e_recursos(count_recursos, "Acesso Negado") +
  geom_label(
    data = . %>% distinct(correl, instancia),
    aes(
      label = str_glue("Correlação:\n{round(correl, 3)}"),
      x = 0.1,
      y = 0.95
    ),
    alpha = .2,
    color = "gray30",
    size = 3,
    fontface = "bold"
  ) + 
  geom_text(
    data = . %>%
      filter(perc_recursos_quando_decisao >= .15 | perc_decisao > .3,
             !str_detect(orgao, "^COAF|^BB ")),
    aes(label = str_extract(orgao, "^[:upper:]+(?= )|^GSI-PR")),
    size = 2.5,
    fontface = "bold",
    color = "gray30",
    angle = 45,
    hjust = 0
  ) +
  geom_text(
    data = . %>%
      filter(perc_recursos_quando_decisao >= .25 & perc_decisao > .3),
    aes(label = str_extract(orgao, "^[:upper:]+(?= )|^GSI-PR")),
    size = 2.5,
    fontface = "bold",
    color = "gray30",
    hjust = 1,
    angle = 45
  )
```

```{r fig.width=10}
plot_correlacao_negativas_e_recursos(count_recursos, "Acesso Concedido") +
  geom_label(
    data = . %>% distinct(correl, instancia),
    aes(
      label = str_glue("Correlação:\n{round(correl, 3)}"),
      x = 0.25,
      y = 0.8
    ),
    alpha = .2,
    color = "gray30",
    size = 3,
    fontface = "bold"
  )
```

```{r fig.width=10}
plot_correlacao_negativas_e_recursos(count_recursos, 
                                     "Acesso Parcialmente Concedido") +
  geom_label(
    data = . %>% distinct(correl, instancia),
    aes(
      label = str_glue("Correlação:\n{round(correl, 3)}"),
      x = 0.05,
      y = 0.8
    ),
    alpha = .2,
    color = "gray30",
    size = 3,
    fontface = "bold"
  )
```
